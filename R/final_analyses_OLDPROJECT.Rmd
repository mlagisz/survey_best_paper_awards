---
title: "final_analyses"
author: "ML"
date: "30/10/2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
library(DT)
library(ggimage)
library(ggcharts)
library(scales)
library(lme4)

options("scipen" = 100, "digits" = 4) #set numeric notation
## set a plotting theme
theme_set(theme_classic(base_size = 14) + 
            theme(panel.background = element_blank(), 
                  plot.background = element_blank(), 
                  legend.background = element_blank(), 
                  text = element_text(colour = "white")))
```



## BR awards

### Load and process data

```{r BR load and clean data}
BRdata <- read_csv(file = here("data", "Copy of Ecoevo_awards_survey-Best_researcher (final) - Form Responses 1.csv"))
str(BRdata)
BRdata <- select(BRdata, -c(1:2)) #remove first two columns (non-informative)
#BR_orig_colnames <- names(BRdata) #store original column names

#rename selected data columns
BRdata <- BRdata %>% 
rename(Award_name = "Full name of the award", 
       Society_name = "Full name of the awarding society", 
       Disciplinary_focus = "Disciplinary focus",
       Geographical_range = "Geographical range", 
       EDI_policies = "Commitment to EDI in the society policies",
       EDI_structures = "Commitment to EDI in the society structures",
       Career_stage = "Target career stage of eligible applicants, as stated in the award information",
       Flexible_eligibility = "Flexibility of the eligibility criteria", 
       Inclusivity_statement = "Inclusivity statement", 
       Assessors_transparency = "Assessors transparency", 
       Process_transparency = "Process transparency",
       Feedback_availability = "Feedback availability",
       Criteria_transparency = "Criteria transparency",
       Relative_opportunity = "Assessment relatively to opportunity",  
       Diverse_contributions = "Valuing diverse contributions",    
       Open_science = "Valuing Open Science",  
       Self_nomination = "Self-nomination allowed",
       Letter_required = "Letter required", 
       Awardee_years = "Awardee list number of years",  
       N_female_2011_2020 = "Number of female awardees 2011-2020", 
       N_male_2011_2020 = "Number of male awardees 2011-2020",  
       N_missing_2011_2020 = "Number of awardees with unassignable gender 2011-2020",
       N_female_2001_2010 = "Number of female awardees 2001-2010", 
       N_male_2001_2010 = "Number of male awardees 2001-2010", 
       N_missing_2001_2010 = "Number of awardees with unassignable gender 2001-2010",
       N_female_1991_2000 = "Number of female awardees 1991-2000", 
       N_male_1991_2000 = "Number of male awardees 1991-2000",  
       N_missing_1991_2000 = "Number of awardees with unassignable gender 1991-2000", 
       N_female_1981_1990 = "Number of female awardees  1981-1990",
       N_male_1981_1990 = "Number of male awardees  1981-1990",
       N_missing_1981_1990 = "Number of awardees with unassignable gender 1981-1990", 
       N_more_data = "More awardee data"
       )
#names(BRdata)

#create a new column Award by combining society and award names:
BRdata %>% 
  mutate(Award = case_when(Award_name == "Open Science in Practice" ~ "SORTEE Open Science in Practice",
                           Award_name == "John Maynard Smith Prize" ~ "ESEB Maynard Smith Prize",
                           Award_name == "President's Award" ~ "ESEB President's Award",
                           Award_name == "T. Dobzhansky Prize" ~ "SSE Dobzhansky Prize",
                           Award_name == "ASN Distinguished Naturalist Award (previously E. O. Wilson Naturalist Award)" ~ "ASN Distinguished Naturalist Award",
                           Award_name == "ASN Early Career Investigator Awardn (Previously Jasper Loftus-Hills Young Investigator Award, the Young Investigator Prize, and the Jasper Loftus-Hills Young Investigator Prize)" ~ "ASN Early Career Investigator Award",
                           Award_name == "GfÖ-Prize" ~ "ESGAS GfÖ-Prize",
                           Award_name == "SMBE Early-Career Excellence Award" ~ "SMBE Early-Career Excellence Award",
                           Award_name == "SMBE Mid-Career Excellence Award" ~ "SMBE Mid-Career Excellence Award",
                           Award_name == "The Bicentenary Medal" ~ "LSL The Bicentenary Medal",
                           Award_name == "International Recognition of Professional Excellence" ~ "IEI Professional Excellence",
                           Award_name == "Robert H. MacArthur Award" ~ "ESA MacArthur Award",
                           Award_name == "Founders’ Prize" ~ "BES Founders’ Prize"
                           )
         ) -> BRdata

#Create reverse values on Letter_not_required - so "yes" is better
BRdata %>% 
  mutate(Letter_not_required = case_when(Letter_required == "yes" ~ "no",
                           Letter_required == "no" ~ "yes",
                           Letter_required == "uncelar" ~ "unclear",
                           )) -> BRdata


#Merge and shorten Society and Award names for plotting:
BRdata %>% 
  mutate(Award = case_when(Award_name == "Open Science in Practice" ~ "SORTEE Open Science in Practice",
                           Award_name == "John Maynard Smith Prize" ~ "ESEB Maynard Smith Prize",
                           Award_name == "President's Award" ~ "ESEB President's Award",
                           Award_name == "T. Dobzhansky Prize" ~ "SSE Dobzhansky Prize",
                           Award_name == "ASN Distinguished Naturalist Award (previously E. O. Wilson Naturalist Award)" ~ "ASN Distinguished Naturalist Award",
                           Award_name == "ASN Early Career Investigator Awardn (Previously Jasper Loftus-Hills Young Investigator Award, the Young Investigator Prize, and the Jasper Loftus-Hills Young Investigator Prize)" ~ "ASN Early Career Investigator Award",
                           Award_name == "GfÖ-Prize" ~ "ESGAS GfÖ-Prize",
                           Award_name == "SMBE Early-Career Excellence Award" ~ "SMBE Early-Career Excellence Award",
                           Award_name == "SMBE Mid-Career Excellence Award" ~ "SMBE Mid-Career Excellence Award",
                           Award_name == "The Bicentenary Medal" ~ "LSL The Bicentenary Medal",
                           Award_name == "International Recognition of Professional Excellence" ~ "IEI Professional Excellence",
                           Award_name == "Robert H. MacArthur Award" ~ "ESA MacArthur Award",
                           Award_name == "Founders’ Prize" ~ "BES Founders’ Prize"
                           )
         ) -> BRdata

#BRdata$Award

```


### Tables

Society-related descriptive and categorical data

```{r BR summary table using DT}

#prepare data - select columns with descriptive values on the awarding societies
BRdata %>% select(Award, Society_name, Disciplinary_focus, Geographical_range, Career_stage, EDI_policies, EDI_structures) -> BRdata1

#format using functions from DT package:
datatable(BRdata1, options = list(pageLength = 15, autoWidth = TRUE)) %>% 
  formatStyle(columns = colnames(BRdata1), 
              backgroundColor = styleEqual(c("yes", "no", "unclear"), c("#009E73", "#D55E00", "#999999"))
             )

#write.csv(BRdata1, here("tables","BR_awards_table_v0.csv"))
```


Table of coded characteristics dota using columns with yes/no/unclear answers

```{r BR coded data table, echo = FALSE}
#prepare data - select columns with yes/no/unclear values
BRdata %>% select(Award, Flexible_eligibility, Self_nomination, Letter_not_required, Inclusivity_statement, Assessors_transparency, Process_transparency, Criteria_transparency, Diverse_contributions, Open_science, Relative_opportunity, Feedback_availability) -> BRdata2

#replace coded values with simpler symbols:
BRdata2[BRdata2 == "yes"] <- "V"
BRdata2[BRdata2 == "no"] <- "X"
BRdata2[BRdata2 == "unclear"] <- "?"

#format using functions from DT package:
datatable(BRdata2, options = list(pageLength = 15, autoWidth = TRUE)) %>% 
  formatStyle(columns = colnames(BRdata2),
              fontWeight = "bold",
              color = styleEqual(c("V", "X", "?"), c("#009e73", "#cc79a7", "#999999"))
             )

#write.csv(BRdata2, here("tables","BR_awards_results_v0.csv"))
```


### Simple plots

Plot the range of years for which awardee info is available

```{r BR plot award years, echo = FALSE}
BRdata %>%
  bar_chart(x = Award, y = Awardee_years) + 
  theme_classic() +
  ylim(0, 80) +
  ylab("Year range of awardee data") +
  xlab("Best Researcher award") 

#ggsave(here("plots", "BR_awards_years_range_v0.png"), width = 18, height = 10, units = "cm", dpi = "retina")
#ggsave(here("plots", "BR_awards_years_range_v0.pdf"), width = 18, height = 10, units = "cm")
```


Plot awardee genders across award decades

```{r BR plot awardees gender by decades, echo = FALSE}
names(BRdata)
#Reshape data for plotting
BRdata %>% select(Award, 
                  N_female_2011_2020,
                  N_male_2011_2020, 
                  N_missing_2011_2020, 
                  N_female_2001_2010, 
                  N_male_2001_2010, 
                  N_missing_2001_2010, 
                  N_female_1991_2000, 
                  N_male_1991_2000, 
                  N_missing_1991_2000, 
                  N_female_1981_1990, 
                  N_male_1981_1990, 
                  N_missing_1981_1990)  -> BRdata3

## replace all NA with 0 (optional):
BRdata3[is.na(BRdata3)] <- 0

## reshape into long dataframe format:
BRdata3 %>% gather(key = var_name, value = value, 2:ncol(BRdata3)) -> BRdata3long

## create new variables coding gender and years:
BRdata3long %>% 
  mutate(Gender = case_when(startsWith(var_name, "N_female_") ~ "female",
                           startsWith(var_name, "N_male_") ~ "male",
                           startsWith(var_name, "N_missing") ~ "unassigned",
                           TRUE ~ "NA")) %>% 
  mutate(Years = case_when(endsWith(var_name, "2011_2020") ~ "2011-2020",
                           endsWith(var_name, "2001_2010") ~ "2001-2010",
                           endsWith(var_name, "1991_2000") ~ "1991-2000",
                           endsWith(var_name, "1981_1990") ~ "1981-1990",
                           TRUE ~ "NA")) -> BRdata3long

## set the levels in order we want:
BRdata3long$Gender <- factor(BRdata3long$Gender, levels = c("male", "female", "unassigned"))
#BRdata3long$Years <- factor(BRdata3long$Years, levels = c("2011-2020", "2001-2010", "1991-2000", "1981-1990"))
BRdata3long$Award <- factor(BRdata3long$Award, levels = rev(c("SORTEE Open Science in Practice","ESGAS GfÖ-Prize","LSL The Bicentenary Medal","SMBE Early-Career Excellence Award","SMBE Mid-Career Excellence Award","ESEB President's Award","BES Founders’ Prize","ASN Distinguished Naturalist Award","ESEB Maynard Smith Prize","IEI Professional Excellence","ASN Early Career Investigator Award","ESA MacArthur Award","SSE Dobzhansky Prize"))) #from oldest to newest

# ## plot for a single award - not stacked, with count values:
# BRdata3long %>% 
#   filter(Award == "ASN Early Career Investigator Award") %>% 
#   ggplot(aes(x = Years, y = value)) +
#   geom_bar(aes(fill = Gender), stat = "identity", position = position_dodge(0.9)) +
#   scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) +
#   theme_classic()

## plot for a all awards, as facets - not stacked, with count values:
BRdata3long %>% 
  filter(Award != "SORTEE Open Science in Practice") %>% 
  ggplot(aes(x = Years, y = value)) +
  geom_bar(aes(fill = Gender), stat = "identity", position = position_dodge(0.9)) +
  facet_wrap(~Award, scales = "fixed", nrow = 4, ncol = 3) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) +
  theme_classic() +
  theme(legend.position="top", legend.box = "horizontal", axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Awardee name") +
  ylab("Count") 

#ggsave(here("plots", "BR_awards_gender_years_counts.png"), width = 18, height = 20, units = "cm", dpi = "retina")
#ggsave(here("plots", "BR_awards_gender_years_counts.pdf"), width = 18, height = 20, units = "cm")

## plot for a all awards, as facets - not stacked, with percent values
BRdata3long %>% 
  filter(Award != "SORTEE Open Science in Practice") %>% 
  ggplot(aes(x = Years, y = value)) +
  geom_bar(aes(fill = Gender), stat = "identity", position = "fill") +
  facet_wrap(~Award, scales = "fixed", nrow = 4, ncol = 3) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) +
  geom_abline(slope = 0, intercept = 0.5, col = "red", lty = 2) + 
  theme_classic() +
  theme(legend.position="top", legend.box = "horizontal", axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Awardee name") +
  ylab("Percent") + 
  scale_y_continuous(labels = scales::percent)

#ggsave(here("plots", "BR_awards_gender_years_v1.png"), width = 18, height = 20, units = "cm", dpi = "retina")
#ggsave(here("plots", "BR_awards_gender_years_v1.pdf"), width = 18, height = 20, units = "cm")

## plot for a all awards, as facets - not stacked, with percent values and count values
BRdata3long %>% 
  mutate(Award_year = paste(Award, Years)) %>%
  group_by(Award_year) %>% 
  mutate(Perc = value/sum(value)) %>% 
  filter(value != 0) %>% 
  ggplot(aes(Years, Perc, fill = Gender), stat = "identity", position = "fill") + 
  facet_wrap(~Award, scales = "fixed", nrow = 4, ncol = 3) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) + 
  geom_col(position = position_stack()) + 
  geom_text(aes(label = value), position = position_stack(vjust = 0.5), size = 4) +
  geom_abline(slope = 0, intercept = 0.5, col = "red", lty = 2) + 
  theme_classic() +
  theme(legend.position = "top", legend.box = "horizontal", axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Awardee name") +
  ylab("Percent") + 
  scale_y_continuous(labels = scales::percent)

#ggsave(here("plots", "BR_awards_gender_years_v2.png"), width = 18, height = 20, units = "cm", dpi = "retina")
#ggsave(here("plots", "BR_awards_gender_years_v2.pdf"), width = 18, height = 20, units = "cm")
```


### Analysis of gender bias

Statistical analysis of the gender difference in awardee names across decades

```{r BR gender stats}
#create new column with a single number representing last year of the decade:
BRdata3long$Decade <- as.numeric(str_sub(BRdata3long$Years, start = -4)) 

#reshape to have female and male numbers for each decade and award:
BRdata3long %>% pivot_wider(id_cols = c(Award, Years, Decade), # optional vector of columns you do not want affected
  names_from = c(Gender), # category column(s) to pivot from long to wide
  values_from = c(value), # value columns(s) that hold data for each category column
  #names_sep # optional string separator for category-value columns
) -> dat_BR
#str(dat)

#Scale the Decade variable to have the mean of 0 and SD of 1
dat_BR$sdecade <- scale(dat_BR$Decade)

#Fit generalised mixed model with binomial error family and with logit link function, award as a random effect (using glmer from lme4 package):
mod_BR <- glmer(cbind(female, male) ~ 1 + (1 | Award), family = "binomial", data = dat_BR) #across all decades
summary(mod_BR)
#calculate % female names at the intercept
plogis(summary(mod_BR)$coef[1,1])*100 # 31% female names
#summary(mod_BR)$coef[1,1] #estimate of the Intercept 
#summary(mod_BR)$coef[1,2] #SE of estimate of the Intercept 
summary(mod_BR)$coef[1,1] - 1.96 * summary(mod_BR)$coef[1,2] #CI.l
summary(mod_BR)$coef[1,1] + 1.96 * summary(mod_BR)$coef[1,2] #CI.u
dim(dat_BR)[1] #sample size

## Model with decade effect:
mod_BR <- glmer(cbind(female, male) ~ sdecade + (1 | Award), family = "binomial", data = dat_BR) 
summary(mod_BR)
summary(mod_BR)$coef[2,] #signif. reduction of bias across decades
#calculate % female names at the intercept (year 2005):
plogis(summary(mod_BR)$coef[1,1])*100 # 25% female names around 2005
```



## BP awards

### Load and process data

```{r BP load and clean data}
BPdata <- read_csv(file = here("data", "Copy of Ecoevo_awards_survey-Best_paper (final) - Form Responses 1.csv"))
str(BPdata)
names(BPdata)

BPdata <- select(BPdata, -c(1:2)) #remove first two columns (non-informative)
#BP_orig_colnames <- names(BPdata) #store original column names

#rename selected data columns
BPdata <- BPdata %>% 
rename(Award_name = "Full name of the award", 
       Journal_name = "Full name of the awarding journal", 
       Disciplinary_focus = "Journal disciplinary focus",
       Geographical_range = "Journal geographical range", 
       EDI_policies = "Journal commitment to EDI in the journal policies",
       Career_stage = "Target career stage of eligible applicants, as stated in the award information",
       Flexible_eligibility = "Flexibility of the eligibility criteria", 
       Inclusivity_statement = "Inclusivity statement", 
       Assessors_transparency = "Assessor transparency", 
       Process_transparency = "Process transparency",
       Feedback_availability = "Feedback availability",
       Criteria_transparency = "Criteria transparency",
       Open_science = "Valuing Open Science",  
       Self_nomination = "Self-nomination allowed",
       Letter_required = "Letter required", 
       Awardee_years = "Awardee list number of years",  
       N_female_2011_2020 = "Number of female awardees 2011-2020", 
       N_male_2011_2020 = "Number of male awardees 2011-2020",  
       N_missing_2011_2020 = "Number of awardees with unassignable gender 2011-2020",
       N_female_2001_2010 = "Number of female awardees 2001-2010", 
       N_male_2001_2010 = "Number of male awardees 2001-2010", 
       N_missing_2001_2010 = "Number of awardees with unassignable gender 2001-2010",
       N_female_1991_2000 = "Number of female awardees 1991-2000", 
       N_male_1991_2000 = "Number of male awardees 1991-2000",  
       N_missing_1991_2000 = "Number of awardees with unassignable gender 1991-2000", 
       N_female_1981_1990 = "Number of female awardees  1981-1990",
       N_male_1981_1990 = "Number of male awardees  1981-1990",
       N_missing_1981_1990 = "Number of awardees with unassignable gender 1981-1990", 
       N_more_data = "More awardee data"
       )
#names(BPdata)

#remove excluded award from Oecologia and create a new column Award by combining journal and award names: 
BPdata %>% filter(Journal_name != "Oecologia") %>% 
  mutate(Award = case_when(Journal_name == "Molecular Biology & Evolution; Society for Molecular Biology and Evolution" ~ "MolBiolEvol / SMBE Best Graduate Student Paper",
                           Journal_name == "Genome Biology & Evolution; Society for Molecular Biology and Evolution" ~ "GenomeBiolEvol / SMBE Best Graduate Student Paper",
                           Journal_name == "any journal; Ecological Society of America" ~ "any journal / ESA George Mercer Award",
                           Journal_name == "Journal of Evolutionary Biology; European Society for Evolutionary Biology" ~ "JEvolutionBiol / ESEB Stearns Graduate Student Prize",
                           Journal_name == "Evolution; Society for the Study of Evolution" ~ "Evolution / SSE Outstanding Dissertation Award",
                           Journal_name == "The American Naturalist; American Society of Naturalists" ~ "AmNat / ASN Student Paper Award",
                           Journal_name == "Methods in Ecology and Evolution; British Ecological Society" ~ "MethodsEcolEvol / BES Robert May Prize",
                           Journal_name == "Functional Ecology; British Ecological Society" ~ "FunctEcol / BES Haldane ECR Award",
                           Journal_name == "Ecology Letters; CNRS" ~ "EcolLett / CNRS ECR Award",
                           Journal_name == "Journal of Experimental Biology; The Company of Biologists" ~ "JExpBiol / CoB Outstanding Paper Prize"
                           )
         ) -> BPdata


#Create reverse values on Letter_not_required - so "yes" is better
BPdata %>% 
  mutate(Letter_not_required = case_when(Letter_required == "yes" ~ "no",
                           Letter_required == "no" ~ "yes",
                           Letter_required == "uncelar" ~ "unclear",
                           )) -> BPdata

#BPdata$Award

#set a custom order of Award levels for plotting 
BPdata <- BPdata %>% mutate(Award = factor(Award, levels = c("Evolution / SSE Outstanding Dissertation Award", 
                                                "AmNat / ASN Student Paper Award", 
                                                "EcolLett / CNRS ECR Award",
                                                "FunctEcol / BES Haldane ECR Award",
                                                "JEvolutionBiol / ESEB Stearns Graduate Student Prize",
                                                "JExpBiol / CoB Outstanding Paper Prize",
                                                "MethodsEcolEvol / BES Robert May Prize",
                                                "MolBiolEvol / SMBE Best Graduate Student Paper",
                                                "GenomeBiolEvol / SMBE Best Graduate Student Paper",
                                                "any journal / ESA George Mercer Award"
                                                )))
levels(BPdata$Award)
```


### Tables

Journal-related descriptive and categorical data - as a table

```{r BP table using , eval = TRUE}

#prepare data - select columns with descriptive values on the awarding societies
BPdata %>% select(Award, Journal_name, Disciplinary_focus, Geographical_range, Career_stage, EDI_policies) -> BPdata1

#format using functions from DT package:

datatable(BPdata1, options = list(pageLength = 15, autoWidth = TRUE)) %>% 
  formatStyle(columns = colnames(BPdata1), 
              backgroundColor = styleEqual(c("yes", "no", "unclear"), c("#009E73", "#D55E00", "#999999"))
             )

# unique(BPdata1$Journal_name)
# table(BPdata1$Disciplinary_focus)
# table(BPdata1$Geographical_range)
# table(BPdata1$EDI_policies)
# table(BPdata1$Career_stage)

#write.csv(BPdata1, here("tables","BP_awards_table_v0.csv"))
```


Table of coded characteristics dota using columns with yes/no/unclear answers

```{r BP coded data table, echo = FALSE}
#prepare data - select columns with yes/no/unclear values
BPdata %>% select(Award, Flexible_eligibility, Self_nomination, Letter_not_required, Inclusivity_statement, Assessors_transparency, Process_transparency, Criteria_transparency, Open_science, Feedback_availability) -> BPdata2

#replace coded values with simpler symbols:
BPdata2[BPdata2 == "yes"] <- "V"
BPdata2[BPdata2 == "no"] <- "X"
BPdata2[BPdata2 == "unclear"] <- "?"

#format using functions from DT package:
datatable(BPdata2, options = list(pageLength = 15, autoWidth = TRUE)) %>% 
  formatStyle(columns = colnames(BPdata2),
              fontWeight = "bold",
              color = styleEqual(c("V", "X", "?"), c("#009e73", "#cc79a7", "#999999"))
             )

#write.csv(BPdata2, here("tables","BP_awards_results_v0.csv"))
```


### Simple plots

Plot a dot plot for columns with yes/no/unclear answers

```{r BP dot plot, echo = FALSE}
#prepare data - select columns with yes/no/unclear values
BPdata %>% select(Award, Flexible_eligibility, Inclusivity_statement, Assessors_transparency, Process_transparency, Feedback_availability, Criteria_transparency, Open_science, Self_nomination, Letter_not_required)  -> BPdata2

#reshape and set a custom order of factor levels for plotting (otherwise it will be reverse alphabetical order):
BPdata2 %>%
  gather(key = var_name, value = value, 2:ncol(BPdata2)) %>% 
  arrange(value) %>%
  mutate(var_name = factor(var_name, levels = rev(c("Flexible_eligibility", "Self_nomination", "Letter_not_required", "Inclusivity_statement", "Assessors_transparency", "Process_transparency", "Criteria_transparency", "Open_science", "Feedback_availability")))) %>%
  ggplot(aes(y = var_name, x = Award, col = value)) +
  geom_point(size = 5) +
  scale_color_manual(values = c("#D55E00", "#999999", "#009E73")) +
  theme_minimal() +
  scale_x_discrete(position = "top") +
  theme(panel.grid.major = element_blank(), axis.text.x = element_text(angle = 45, hjust = 0),
        axis.title.x = element_blank(), axis.title.y = element_blank(), 
        panel.border = element_rect(colour = "black", fill = NA),
        plot.margin = margin(t = 25,  # Top margin
                             r = 50,  # Right margin
                             b = 10,  # Bottom margin
                             l = 15)) # Left margin)

ggsave(here("plots","BP_dotplot_v0.png"), #plot = p1, 
       width = 15, height = 15, units = "cm", dpi = "retina")

ggsave(here("plots","BP_dotplot_v0.pdf"), device = "pdf", #plot = p1, 
       width = 15, height = 15, units = "cm", dpi = "retina")
```


Plot the range of years for which awardee info is available

```{r BP plot award years, echo = FALSE}
BPdata %>%
  bar_chart(x = Award, y = Awardee_years) + 
  theme_classic() +
  ylim(0, 80) +
  ylab("Year range of awardee data") +
  xlab("Best Paper award") 

#ggsave(here("plots", "BP_awards_years_range_v0.png"), width = 18, height = 10, units = "cm", dpi = "retina")
#ggsave(here("plots", "BP_awards_years_range_v0.pdf"), width = 18, height = 10, units = "cm")
```


Plot awardee genders across award years

```{r BP plot awardees gender by years, echo = FALSE}
#Reshape data for plotting
BPdata %>% select(Award, 
                  N_female_2011_2020,
                  N_male_2011_2020, 
                  N_missing_2011_2020, 
                  N_female_2001_2010, 
                  N_male_2001_2010, 
                  N_missing_2001_2010, 
                  N_female_1991_2000, 
                  N_male_1991_2000, 
                  N_missing_1991_2000, 
                  N_female_1981_1990, 
                  N_male_1981_1990, 
                  N_missing_1981_1990)  -> BPdata3

## replace all NA with 0 (optional):
BPdata3[is.na(BPdata3)] <- 0

## reshape into long dataframe format:
BPdata3 %>% gather(key = var_name, value = value, 2:ncol(BPdata3)) -> BPdata3long

## create new variables coding gender and years:
BPdata3long %>% 
  mutate(Gender = case_when(startsWith(var_name, "N_female_") ~ "female",
                           startsWith(var_name, "N_male_") ~ "male",
                           startsWith(var_name, "N_missing") ~ "unassigned",
                           TRUE ~ "NA")) %>% 
  mutate(Years = case_when(endsWith(var_name, "2011_2020") ~ "2011-2020",
                           endsWith(var_name, "2001_2010") ~ "2001-2010",
                           endsWith(var_name, "1991_2000") ~ "1991-2000",
                           endsWith(var_name, "1981_1990") ~ "1981-1990",
                           TRUE ~ "NA")) -> BPdata3long

## set the levels in order we want:
BPdata3long$Gender <- factor(BPdata3long$Gender, levels = c("male", "female", "unassigned"))
#BPdata3long$Years <- factor(BPdata3long$Years, levels = c("2011-2020", "2001-2010", "1991-2000", "1981-1990"))
BPdata3long$Award <- factor(BPdata3long$Award, levels = c("any journal / ESA George Mercer Award",
                                                          "Evolution / SSE Outstanding Dissertation Award",
                                                          "FunctEcol / BES Haldane ECR Award",
                                                          "AmNat / ASN Student Paper Award",
                                                          "JExpBiol / CoB Outstanding Paper Prize",
                                                          "MethodsEcolEvol / BES Robert May Prize",
                                                          "JEvolutionBiol / ESEB Stearns Graduate Student Prize",
                                                          "GenomeBiolEvol / SMBE Best Graduate Student Paper",
                                                          "MolBiolEvol / SMBE Best Graduate Student Paper",
                                                          "EcolLett / CNRS ECR Award")) #from longest to shortest years data

# ## plot for a single award - not stacked, with count values:
# BPdata3long %>% 
#   filter(Award == "ASN Early Career Investigator Award") %>% 
#   ggplot(aes(x = Years, y = value)) +
#   geom_bar(aes(fill = Gender), stat = "identity", position = position_dodge(0.9)) +
#   scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) +
#   theme_classic()

## plot for a all awards, as facets - not stacked, with count values:
BPdata3long %>% 
  ggplot(aes(x = Years, y = value)) +
  geom_bar(aes(fill = Gender), stat = "identity", position = position_dodge(0.9)) +
  facet_wrap(~Award, scales = "fixed", nrow = 5, ncol = 2) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) +
  theme_classic() +
  theme(legend.position="top", legend.box = "horizontal", axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(breaks = c(0, 2, 4, 6, 8), minor_breaks = NULL) +
  labs(fill = "Awardee name") +
  ylab("Count") 

#ggsave(here("plots", "BP_awards_gender_years_counts.png"), width = 18, height = 20, units = "cm", dpi = "retina")
#ggsave(here("plots", "BP_awards_gender_years_counts.pdf"), width = 18, height = 20, units = "cm")


## plot for a all awards, as facets- not stacked, with percent values
BPdata3long %>% 
  ggplot(aes(x = Years, y = value)) +
  geom_bar(aes(fill = Gender), stat = "identity", position = "fill") +
  facet_wrap(~Award, scales = "fixed", nrow = 5, ncol = 2) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) +
  geom_abline(slope = 0, intercept = 0.5, col = "red",lty = 2) + 
  theme_classic() +
  theme(legend.position = "top", legend.box = "horizontal", axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Awardee name") +
  ylab("Percent") + 
  scale_y_continuous(labels = scales::percent)


#ggsave(here("plots", "BP_awards_gender_years_v1.png"), width = 18, height = 20, units = "cm", dpi = "retina")
#ggsave(here("plots", "BP_awards_gender_years_v1.pdf"), width = 18, height = 20, units = "cm")


## plot for a all awards, as facets- not stacked, with percent values and count values
BPdata3long %>% 
  mutate(Award_year = paste(Award, Years)) %>%
  group_by(Award_year) %>% 
  mutate(Perc = value/sum(value)) %>% 
  filter(value != 0) %>% 
  ggplot(aes(Years, Perc, fill = Gender), stat = "identity", position = "fill") + 
  facet_wrap(~Award, scales = "fixed", nrow = 5, ncol = 2) +
  scale_fill_manual(values = c("#56B4E9", "#E69F00", "#999999")) + 
  geom_col(position = position_stack()) + 
  geom_text(aes(label = value), position = position_stack(vjust = 0.5), size = 4) +
  geom_abline(slope = 0, intercept = 0.5, col = "red", lty = 2) + 
  theme_classic() +
  theme(legend.position = "top", legend.box = "horizontal", axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(fill = "Awardee name") +
  ylab("Percent") + 
  scale_y_continuous(labels = scales::percent)

#ggsave(here("plots", "BP_awards_gender_years_v2.png"), width = 18, height = 20, units = "cm", dpi = "retina")
#ggsave(here("plots", "BP_awards_gender_years_v2.pdf"), width = 18, height = 20, units = "cm")
```


### Analysis of gender bias

Statistical analysis of the gender difference in awardee names across decades

```{r BP gender stats}
#create new column with a single number representing last year of the decade:
BPdata3long$Decade <- as.numeric(str_sub(BPdata3long$Years, start = -4)) 

#reshape to have female and male numbers for each decade and award:
BPdata3long %>% pivot_wider(id_cols = c(Award, Years, Decade), # optional vector of columns you do not want affected
  names_from = c(Gender), # category column(s) to pivot from long to wide
  values_from = c(value), # value columns(s) that hold data for each category column
  #names_sep # optional string separator for category-value columns
) -> dat_BP
#str(dat_BP)

#Scale the Decade variable to have the mean of 0 and SD of 1
dat_BP$sdecade <- scale(dat_BP$Decade)

#Fit generalised mixed model with binomial error family and with logit link function, award as a random effect (using glmer from lme4 package). Note that due to limited time coverage it was not possible to include Decade variable:
mod_BP <- glmer(cbind(female, male) ~ 1 + (1 | Award), family = "binomial", data = dat_BP) #across all decades
summary(mod_BP)
#calculate % female names at the intercept
plogis(summary(mod_BP)$coef[1,1])*100 # 45% female names
#summary(mod_BP)$coef[1,1] #estimate of the Intercept 
#summary(mod_BP)$coef[1,2] #SE of estimate of the Intercept 
summary(mod_BP)$coef[1,1] - 1.96 * summary(mod_BP)$coef[1,2] #CI.l
summary(mod_BP)$coef[1,1] + 1.96 * summary(mod_BP)$coef[1,2] #CI.u
dim(dat_BP)[1] #sample size

## Model with decade effect:
#mod_BP <- glmer(cbind(female, male) ~ sdecade + (1 | Award), family = "binomial", data = dat_BP) #does not run - too few points across decades
```



## Ad-hoc data and analyses  

### Geographical data  

Additional data on the awardees' country of affiliations at the time of award was collected post-hoc at the request of the manuscript reviewers. Affiliations were extracted from award pages, award press releases, ORCID records or publications dated from the same year as the award. Only first affiliation was recorded if multiple affiliations were listed for a given publication. Data is saved in "survey_ecoevo_awards - awardees_individual.csv". This also resulted in a data frame that has gender assigned to individual names.   

### Load and process additional data  

```{r BR load and clean data}
GEOdata <- read_csv(file = here("data", "survey_ecoevo_awards - awardees_individual.csv"))
GEOdata <- as_tibble(GEOdata)
str(GEOdata)

#rename selected data columns
GEOdata <- GEOdata %>% 
rename(Award_category = "award category", 
       Award_name = "award name", 
       Award_link = "award source link"
       )
#names(GEOdata)

table(GEOdata$Award_category)
table(GEOdata$gender) #M
table(GEOdata$country) #USA
#table(GEOdata$affiliation) #needs dome cleaning, but University of California at Davis seems to be the top one
#table(GEOdata$Award_name)

#Rename some awards so they have the  same names as used above:
GEOdata %>% 
  mutate(Award_name = case_when(
    Award_name == "American Naturalist Student Paper Award" ~ "AmNat / ASN Student Paper Award", 
    Award_name == "Early Career Researcher Award" ~ "EcolLett / CNRS ECR Award", 
    Award_name == "Edward O. Wilson Naturalist Award" ~ "ASN Distinguished Naturalist Award", 
    Award_name == "Founders’ Prize" ~ "BES Founders Prize",
    Award_name == "GBE Best Graduate Student Paper" ~ "GenomeBiolEvol / SMBE Best Graduate Student Paper",
    Award_name == "George Mercer Award" ~ "any journal / ESA George Mercer Award", 
    Award_name == "Haldane Early Career Researcher Award" ~ "FunctEcol / BES Haldane ECR Award",
    Award_name == "International Recognition of Professional Excellence" ~ "IEI Professional Excellence", 
    Award_name == "Jasper Loftus-Hills Young Investigator Award" ~ "ASN Early Career Investigator Award", 
    Award_name == "John Maynard Smith Prize" ~ "ESEB Maynard Smith Prize", 
    Award_name == "MBE Best Graduate Student Paper" ~ "MolBiolEvol / SMBE Best Graduate Student Paper",
    Award_name == "Outstanding paper prize" ~ "JExpBiol / CoB Outstanding Paper Prize", 
    Award_name == "President's Award" ~ "ESEB President's Award", 
    Award_name == "Presidents’ Award for Outstanding Dissertation Paper in Evolution" ~  "Evolution / SSE Outstanding Dissertation Award",
    Award_name == "Robert H. MacArthur Award" ~ "ESA MacArthur Award", 
    Award_name == "Robert May Prize" ~ "MethodsEcolEvol / BES Robert May Prize",
    Award_name == "SMBE Early-Career Excellence Award" ~ "SMBE Early-Career Excellence Award", 
    Award_name == "SMBE Mid-Career Excellence Award" ~ "SMBE Mid-Career Excellence Award", 
    Award_name == "Stearns Graduate Student Prize" ~ "JEvolutionBiol / ESEB Stearns Graduate Student Prize",
    Award_name == "T. Dobzhansky Prize" ~ "SSE Dobzhansky Prize", 
    Award_name == "The Bicentenary Medal" ~ "LSL The Bicentenary Medal",
    Award_name == "GfÖ-Prize" ~ "ESGAS GfO-Prize"
    )
  ) -> GEOdata
                                                
```


### Alternative gender bias analyses

Alternative statistical analyses of the gender difference in BR awardee names across years - using individual-level data

```{r BR gender stats years}
#str(GEOdata)
GEOdata %>% filter(Award_category == "BR") %>% filter(gender != "X") %>% mutate(Gender = case_when(
    endsWith(gender, "F") ~ 1,
    endsWith(gender, "M") ~ 0
    )) -> GEOdata_BR
#str(GEOdata_BR)
table(GEOdata_BR$gender)
table(GEOdata_BR$Gender)

#Scale the award_year variable to have the mean of 0 and SD of 1
GEOdata_BR$Award_year_scaled <- scale(GEOdata_BR$award_year)

#Fit generalised mixed model with binomial error family and with logit link function, award as a random effect (using glmer from lme4 package):
model_BR <- glmer(Gender ~ Award_year_scaled + (1|Award_name), family = "binomial", data = GEOdata_BR) #with year as a predictor
summary(model_BR)

#calculate % difference between genders at the intercept:
plogis(summary(model_BR)$coef[1,1])*100 # 28% female names - similar pattern to the analyses across decades
```

Alternative statistical analysis of the gender difference in BP awardee names across years - using individual-level data

```{r BP gender stats years}
#str(GEOdata)
GEOdata %>% filter(Award_category == "BP") %>% filter(gender != "X") %>% mutate(Gender = case_when(
    endsWith(gender, "F") ~ 1,
    endsWith(gender, "M") ~ 0
    )) -> GEOdata_BP
#str(GEOdata_BP)
table(GEOdata_BP$gender)
table(GEOdata_BP$Gender)

#Scale the award_year variable to have the mean of 0 and SD of 1
GEOdata_BP$Award_year_scaled <- scale(GEOdata_BP$award_year)

#Fit generalised mixed model with binomial error family and with logit link function, award as a random effect (using glmer from lme4 package):
#model_BP <- glmer(Gender ~ Award_year_scaled + (1|Award_name), family = "binomial", data = GEOdata_BP) #with year as a predictor - not working
model_BP <- glmer(Gender ~ 1 + (1|Award_name), family = "binomial", data = GEOdata_BP) #without year as a predictor
summary(model_BP)

#calculate % difference between genders at the intercept:
plogis(summary(model_BP)$coef[1,1])*100 # 43% female names- similar pattern to the analyses across decades
```


### Geographic bias

Country of affiliation of the past awardees

```{r plot awardees country by decades, echo = FALSE}
#str(GEOdata)
table(GEOdata$country) #only USA, UK, Canada, Australia, France, Switzerland, Germany > 5

GEOdata$Country <- recode(GEOdata$country, USA = "USA", UK = "UK", Canada = "Canada", Australia = "Australia", France = "France", Switzerland = "Switzerland", Germany = "Germany", .default = "other")
table(GEOdata$Country)

## for BR awards
GEOdata %>% 
  filter(Award_category == "BR") %>% 
  filter(!is.na(Country)) %>%
  count(Country) #198 out of 297 from USA, only 16 (10%) from "other countries"
  
GEOdata %>% 
  filter(Award_category == "BR") %>% 
  #filter(award_year > 2010) %>% 
  filter(!is.na(Country)) %>% 
  #count(Country)
  count(Award_name, Country) %>% 
  ggplot(aes(y = Award_name, x = n, fill = Country)) +
  #geom_bar(stat = "identity")
  geom_bar(aes(fill = Country), stat = "identity") +
  scale_fill_manual(values = c("#F0E442", "#56B4E9", "#009E73", "#0072B2", "#000000", "#D55E00", "#E69F00", "#CC79A7")) +
  theme_classic() + 
  xlab("Count")

#ggsave(here("plots", "BR_awards_country_v1.png"), width = 18, height = 8, units = "cm", dpi = "retina")
#ggsave(here("plots", "BR_awards_country_v1.pdf"), width = 18, height = 8, units = "cm")


## for BP awards
GEOdata %>% 
  filter(Award_category == "BP") %>% 
  filter(!is.na(Country)) %>%
  count(Country) #103 out of 160 from USA, only 16 (10%) from "other countries"

GEOdata %>% 
  filter(Award_category == "BP") %>% 
  #filter(award_year > 2010) %>% 
  filter(!is.na(Country)) %>% 
  #count(Country)
  count(Award_name, Country) %>% 
  ggplot(aes(y = Award_name, x = n, fill = Country)) +
  #geom_bar(stat = "identity")
  geom_bar(aes(fill = Country), stat = "identity") +
  scale_fill_manual(values = c("#F0E442", "#56B4E9", "#009E73", "#0072B2", "#000000", "#D55E00", "#E69F00", "#CC79A7")) +
  theme_classic() + 
  xlab("Count")

#ggsave(here("plots", "BP_awards_country_v1.png"), width = 18, height = 8, units = "cm", dpi = "retina")
#ggsave(here("plots", "BP_awards_country_v1.pdf"), width = 18, height = 8, units = "cm")
```


### First name bias 

```{r first names, echo = FALSE}
#str(GEOdata)

## all data

#extract first names:
GEOdata$awardee_name_first <- word(GEOdata$awardee_name, 1)

#most frequent names overall:
GEOdata %>% count(awardee_name_first) %>% arrange(desc(n))

## most frequent first names of the past awardees for BR:
GEOdata %>% 
  filter(Award_category == "BR") %>%
  count(awardee_name_first) %>%
  arrange(desc(n)) %>%
  slice(1:10) %>%
  bar_chart(x = awardee_name_first, y = n) + 
  theme_classic() +
  ylim(0, 13) +
  ylab("Count") +
  xlab("Top 10 first names of the BR awardees") 

#ggsave(here("plots", "BR_awards_first_names_v0.png"), width = 18, height = 8, units = "cm", dpi = "retina")
#ggsave(here("plots", "BR_awards_first_names_v0.pdf"), width = 18, height = 8, units = "cm")


## most frequent first names of the past awardees for BP:
GEOdata %>% 
  filter(Award_category == "BP") %>%
  count(awardee_name_first) %>%
  arrange(desc(n)) %>%
  slice(1:10) %>%
  bar_chart(x = awardee_name_first, y = n) + 
  theme_classic() +
  ylim(0, 13) +
  ylab("Count") +
  xlab("Top 10 first names of the BP awardees") 

#ggsave(here("plots", "BP_awards_first_names_v0.png"), width = 18, height = 8, units = "cm", dpi = "retina")
#ggsave(here("plots", "BP_awards_first_names_v0.pdf"), width = 18, height = 8, units = "cm")

```



